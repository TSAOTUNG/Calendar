<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的行事曆</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F9F2"> <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F9F2',       // 淺綠白背景
                        card: '#FFFFFF',     // 卡片白
                        primary: '#4A5A4A',  // 深灰綠文字
                        secondary: '#889988',// 次要文字
                        accent: '#D4ECD4',   // 淺綠強調色
                        accentBtn: '#BCE0BC',// 按鈕綠
                        accentText: '#2F5F2F', // 深綠文字
                        danger: '#FFEEEE',   // 刪除按鈕背景
                        dangerText: '#CC5555' // 刪除按鈕文字
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #F2F9F2; 
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 修復時間輸入框在 iOS 上的外觀 */
        input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #F9FAFB;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Pill: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="6" width="20" height="12" rx="6"></rect><path d="M12 6v12"></path></svg>,
            ChevronDown: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            X: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Clock: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        };

        const generateDates = (startDate, daysToAdd) => {
            const dates = [];
            let current = new Date(startDate);
            current.setHours(0,0,0,0);
            
            const today = new Date();
            today.setHours(0,0,0,0);

            if (current < today) {
                current = new Date(today);
            }

            for (let i = 0; i < daysToAdd; i++) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };

        const formatDateKey = (dateObj) => {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDayName = (dateObj) => {
            const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            return days[dateObj.getDay()];
        };

        const getCurrentTimeStr = () => {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        };

        const App = () => {
            const [events, setEvents] = useState({}); 
            const [displayDates, setDisplayDates] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            
            const [inputType, setInputType] = useState('event'); 
            const [inputTitle, setInputTitle] = useState('');
            const [inputTime, setInputTime] = useState('');
            const [inputNotes, setInputNotes] = useState('');

            useEffect(() => {
                const saved = localStorage.getItem('green_calendar_db');
                if (saved) {
                    setEvents(JSON.parse(saved));
                } else {
                    setEvents({});
                }
                setDisplayDates(generateDates(new Date(), 60)); 
            }, []);

            useEffect(() => {
                localStorage.setItem('green_calendar_db', JSON.stringify(events));
            }, [events]);

            const handleLoadMore = () => {
                const lastDate = displayDates[displayDates.length - 1];
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + 1);
                const newBatch = generateDates(nextDate, 30);
                setDisplayDates(prev => [...prev, ...newBatch]);
            };

            const handleDeleteItem = (e, dateKey, itemId) => {
                e.stopPropagation();
                if (!confirm('確定要刪除這個項目嗎？')) return;

                setEvents(prev => {
                    const currentItems = prev[dateKey]?.items || [];
                    const newItems = currentItems.filter(item => item.id !== itemId);
                    return { ...prev, [dateKey]: { items: newItems } };
                });
            };

            const openModal = (date) => {
                setSelectedDate(date);
                setIsModalOpen(true);
                setInputType('event');
                setInputTitle('');
                setInputTime('');
                setInputNotes('');
            };

            const handleTypeSwitch = (type) => {
                setInputType(type);
                if (type === 'meds') {
                    setInputTime(getCurrentTimeStr());
                    setInputTitle('吃藥紀錄'); 
                } else {
                    setInputTime('');
                    setInputTitle('');
                }
            };

            const handleSubmit = () => {
                if (!inputTitle && inputType !== 'meds') return;

                const dateKey = formatDateKey(selectedDate);
                const finalTitle = inputType === 'meds' ? (inputTitle || '吃藥紀錄') : inputTitle;
                
                const newEvent = {
                    id: Date.now(),
                    type: inputType,
                    title: finalTitle,
                    notes: inputNotes,
                    time: inputTime
                };

                setEvents(prev => {
                    const currentDay = prev[dateKey] || { items: [] };
                    const updatedItems = [...currentDay.items, newEvent];
                    updatedItems.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
                    return { ...prev, [dateKey]: { items: updatedItems } };
                });
                setIsModalOpen(false);
            };

            const renderDateRow = (dateObj) => {
                const dateKey = formatDateKey(dateObj);
                const dayData = events[dateKey] || { items: [] };
                
                const todayStr = formatDateKey(new Date());
                const isToday = todayStr === dateKey;
                const isFirstOfMonth = dateObj.getDate() === 1;

                return (
                    <div key={dateKey} className="flex gap-3 mb-4 select-none fade-in">
                        <div className="flex flex-col items-center w-14 pt-2 flex-shrink-0 text-primary">
                            {isFirstOfMonth && (
                                <span className="text-xs font-bold text-accentText mb-1 bg-accent/50 px-1.5 rounded">
                                    {dateObj.getMonth() + 1}月
                                </span>
                            )}
                            <span className={`text-2xl font-light tracking-tighter ${isToday ? 'font-bold text-accentText' : ''}`}>
                                {dateObj.getDate()}
                            </span>
                            <span className="text-[10px] text-secondary mt-[-2px]">{getDayName(dateObj)}</span>
                        </div>

                        <div 
                            onClick={() => openModal(dateObj)}
                            className={`flex-1 min-h-[70px] bg-card rounded-xl p-3 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border transition-all active:scale-[0.99]
                            ${isToday ? 'border-accent ring-2 ring-accent/30' : 'border-transparent'}`}
                        >
                            {dayData.items.length === 0 ? (
                                <div className="h-full flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                                    <div className="bg-bg rounded-full p-1 text-secondary"><Icons.Plus /></div>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {dayData.items.map((item) => (
                                        <div key={item.id} className="group relative flex items-start text-sm pr-6">
                                            <button 
                                                onClick={(e) => handleDeleteItem(e, dateKey, item.id)}
                                                className="absolute right-[-4px] top-0 p-1.5 text-gray-300 hover:text-dangerText hover:bg-danger rounded-full transition-colors opacity-60 hover:opacity-100"
                                            >
                                                <Icons.X />
                                            </button>

                                            <div className={`w-2 h-2 rounded-full mt-1.5 mr-3 flex-shrink-0 
                                                ${item.type === 'meds' ? 'bg-blue-300' : 'bg-green-300'}`}>
                                            </div>
                                            
                                            <div className="flex-1">
                                                <div className="flex items-center flex-wrap">
                                                    {item.time && <span className="text-secondary font-mono text-xs mr-2">{item.time}</span>}
                                                    <span className="text-primary font-medium">{item.title}</span>
                                                    
                                                    {item.type === 'meds' && (
                                                        <span className="ml-2 bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded-full flex items-center inline-block">
                                                            <span className="mr-0.5"><Icons.Pill /></span> 吃藥
                                                        </span>
                                                    )}
                                                </div>
                                                {item.notes && (
                                                    <div className="text-xs text-secondary mt-0.5 break-words">
                                                        {item.notes}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 font-sans text-primary">
                    <header className="sticky top-0 z-20 bg-[#F2F9F2]/95 backdrop-blur-md px-5 py-4 flex justify-between items-end border-b border-green-50/50">
                        <div>
                            <h1 className="text-xl font-bold tracking-wide text-accentText">My Calendar</h1>
                            <p className="text-xs text-secondary mt-0.5">Today is {new Date().toLocaleDateString()}</p>
                        </div>
                    </header>

                    <main className="px-4 py-6">
                        {displayDates.map(date => renderDateRow(date))}
                        
                        <button 
                            onClick={handleLoadMore}
                            className="w-full py-4 text-secondary text-sm flex items-center justify-center hover:text-accentText transition-colors"
                        >
                            <span className="mr-1">載入更多</span> <Icons.ChevronDown />
                        </button>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-sm" onClick={() => setIsModalOpen(false)}>
                            <div 
                                className="bg-white w-full max-w-sm p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl animate-[slideUp_0.3s_ease-out]" 
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-primary">
                                        {selectedDate.getMonth()+1}月{selectedDate.getDate()}日
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-gray-400 p-2"><Icons.X /></button>
                                </div>

                                <div className="flex gap-3 mb-5">
                                    <button 
                                        onClick={() => handleTypeSwitch('event')}
                                        className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all
                                            ${inputType === 'event' ? 'bg-accent text-accentText shadow-sm' : 'bg-gray-50 text-gray-400'}`}
                                    >
                                        一般行程
                                    </button>
                                    <button 
                                        onClick={() => handleTypeSwitch('meds')}
                                        className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all
                                            ${inputType === 'meds' ? 'bg-blue-100 text-blue-800 shadow-sm' : 'bg-gray-50 text-gray-400'}`}
                                    >
                                        吃藥紀錄
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {/* 標題輸入框 */}
                                    <input 
                                        type="text" 
                                        placeholder={inputType === 'meds' ? "標題 (預設: 吃藥紀錄)" : "事項標題"}
                                        className="w-full bg-gray-50 p-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent font-medium text-primary placeholder-gray-300"
                                        value={inputTitle}
                                        onChange={e => setInputTitle(e.target.value)}
                                        autoFocus
                                    />

                                    {/* 時間與備註：調整寬度比例，移除重疊文字 */}
                                    <div className="flex gap-3">
                                        <div className="w-[35%] flex-shrink-0">
                                            <input 
                                                type="time" 
                                                className="w-full h-full bg-gray-50 p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent text-primary text-center text-sm"
                                                value={inputTime}
                                                onChange={e => setInputTime(e.target.value)}
                                            />
                                        </div>

                                        <textarea
                                            placeholder="備註 (選填)"
                                            rows="1"
                                            className="flex-1 bg-gray-50 p-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent text-sm text-primary placeholder-gray-300 resize-none pt-3.5 leading-normal"
                                            value={inputNotes}
                                            onChange={e => setInputNotes(e.target.value)}
                                        ></textarea>
                                    </div>
                                </div>

                                <button 
                                    onClick={handleSubmit}
                                    className="w-full mt-6 bg-accentBtn text-accentText py-3.5 rounded-xl font-bold active:scale-[0.98] transition-transform shadow-sm"
                                >
                                    新增
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>